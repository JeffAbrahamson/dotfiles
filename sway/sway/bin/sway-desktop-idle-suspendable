#!/bin/bash

. $HOME/bin/p27.sh
logfile="$HOME/sway-desktop-idle"
log_line "sway-desktop-idle-suspendable" >> "$logfile"

if [ "X$HOSTNAME" != Xvogel ]; then
    log_line "Host '$HOSTNAME' not recognised, not invoking swayidle." >> "$logfile"
    exit 0
fi

# My intention is to replace any existing swayidle process I'm running.
pkill -u $LOGNAME swayidle
log_line "Kill note: $?" >> "$logfile"

# Lock screen and suspend.
#
# On wake-up, don't repeat once unlocked.  But do repeat if we don't
# unlock, because a simple nudge of the mouse shouldn't leave us
# unsuspended forever.
swaylock -f -c 000000 &
swayidle -w  \
	 timeout 10 'swaylock -f -c 000000' \
	 timeout 15 'swaymsg "output * dpms off"' \
	 resume 'swaymsg "output * dpms on; $HOME/bin/sway-desktop-idle-what-next"'  \
	 before-sleep 'swaylock -f -c 000000' \
	 timeout 18 'systemctl suspend'
